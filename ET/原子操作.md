# 原子操作atomic operation

原子本意为**不能被进一步分割的最小粒子**，原子操作为**不可被中断的一个或一系列操作**

如果操作不能原子地执行，则要么执行完所有步骤，要么一步也不执行，不可能只执行所有步骤的一个子集。

在多线程中，线程切换要么在原子操作之前，要么原子操作之后。所以，**两个原子操作不可能并发的访问同一个变量。**

## 原子操作原理

### 总线加锁

### 缓存加锁

## 凡是赋值操作在多线程中都需要加锁

一般一条指令大概64位 4个字节。一般的值类型或引用类型赋值都会认为是单条指令执行。引用类型的引用地址刚好是4字节，所以被视为原子操作。

在执行i++、++i的操作中，在汇编时会被分为三个阶段，将i加载到寄存器中，寄存器中的值自增，把寄存器的值写入到内存中，所以被视为非原子操作。

## 自旋锁

使用原子操作模拟互斥锁的行为就是自旋锁，互斥锁状态是由操作系统控制的，自旋锁的状态是程序员自己控制的

### 比较并交换CAS

在使用时，通常记录下指定内存中的旧值，并对旧值进行一系列操作后得到新值，然后通过CAS操作将旧值与新值进行交换。如果这块内存中的值在这期间没被修改过，则旧址会和内存中的值相同，这时CAS操作将会成功执行，并把内存中的数据变换成新值。如果内存中的值发生过改变，则CAS操作将会失败，新值将不会被写入内存。

当CAS操作失败后，会重新从头执行，直到成功为止。CAS操作趋于乐观锁，总是假设被操作值未被修改，CAS操作并不那么容易成功所以需要不断尝试。

#### CAS应用

在应用中CAS可以用于实现无锁数据结构，常见的有无锁队列以及无锁栈，对于可在任意位置插入数据的链表以及双向链表，实现无锁操作的难度较大。