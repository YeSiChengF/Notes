# æ¸¸æˆèµ„æºç®¡ç†

æ¸¸æˆè¿è¡Œå°±æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªèµ„æºçš„å±•ç¤ºï¼Œå¦‚ä½•ç®¡ç†å¥½è¿™äº›å±•ç¤ºçš„èµ„æºè®©æ¸¸æˆèƒ½å¤Ÿæµç•…è¿è¡Œåœ¨å¼€å‘ä¸­éå¸¸é‡è¦ã€‚éœ€è¦åœ¨åˆç†çš„åœ°æ–¹è°ƒç”¨ã€åŠ è½½èµ„æºï¼Œèµ„æºç©ºé—²æ—¶å¯¹å…¶è¿›è¡Œå¸è½½ä»¥å‡å°‘å†…å­˜å ç”¨ã€‚å½“å†…å­˜è¶…å‡ºé¢„ç®—å¯èƒ½å¯¼è‡´æ¸¸æˆé—ªé€€ï¼Œæ‰€ä»¥å¯¹èµ„æºçš„ç®¡ç†å®é™…å°±æ˜¯å¯¹å†…å­˜çš„ä¼˜åŒ–ï¼

æœ¬æ–‡äº‰å–ä¸€æ–‡ææ‡‚èµ„æºç®¡ç†ã€‚PSï¼šå¯èƒ½å’Œä¸€ä¸ªè§†é¢‘å­¦å®Œc++å·®ä¸å¤š(ä¸€ä¸ªè§†é¢‘ä¸€ä¸ªå¤šæœˆ)

TODOLISTï¼š

- [ ] åˆ†åŒ…ç­–ç•¥
- [ ] ä¾èµ–å¤„ç†
- [ ] AssetBundleè¯¦ç»†
- [ ] çƒ­æ›´
  - [ ] æ–­ç‚¹ç»­ä¼ 
  - [ ] ä»£ç çƒ­æ›´æ–°/çƒ­é‡è½½
    - [ ] Luaé‡æ–°å°†å‡½æ•°æŒ‡é’ˆèµ‹å€¼çš„ç­–ç•¥
    - [ ] HybridCLR
- [ ] èµ„æºåŒ…å’Œèµ„æºåŒºåˆ†å¼€
- [ ] ä¸€äº›èµ„æºç­–ç•¥
  - [ ] æ•´åŒ…åªæœ‰åŸºç¡€å†…å®¹ï¼Œåç»­ç« èŠ‚çƒ­æ›´çš„å½¢å¼(å¤§èµ„æºæƒ…å†µ)
- [ ] YooAssetæ‰©å±•ç¯‡

## èµ„æºç®¡ç†ä¸»è¦çš„éœ€æ±‚æœ‰å“ªäº›ï¼Ÿ

- ä¸ºå¼€å‘ä¸æ­£å¼ç‰ˆæœ¬æä¾›èµ„æºçš„åŠ è½½å’Œå¸è½½
- æ”¯æŒè¿œç¨‹æ›´æ–°èµ„æº
- åšå¥½ç‰ˆæœ¬ã€å¹³å°ã€æ¸ é“çš„èµ„æºç®¡ç†
- å†…å­˜ä¼˜åŒ–

## Unityä¸­çš„ä¸¤ç§åŠ è½½æ–¹å¼

### Resources

- èµ„æºå¿…é€‰æ”¾åœ¨Resourcesæ–‡ä»¶å¤¹ä¸‹ï¼›æœ‰å®¹é‡ä¸Šé™(å¤§æ¦‚æ˜¯2G)ï¼›é‡å¤åŠ è½½å’Œé‡å¤å¸è½½æ“ä½œï¼ŒUnityåšäº†å®¹é”™å¤„ç†ä¸ä¼šæŠ¥é”™ã€‚ä¸æ”¯æŒçƒ­æ›´ï¼Œåªèƒ½æ‰“æ•´åŒ…
- é€‚åˆæ”¾æ¸¸æˆçš„å¯åŠ¨é€»è¾‘éœ€è¦çš„èµ„æº
- å¯èƒ½ä¼šå»¶é•¿æ¸¸æˆå¯åŠ¨æ—¶é—´

### AssetBundle

- å¯ä»¥ç†è§£æˆUnityå†…çš„èµ„æºå‹ç¼©åŒ…ï¼Œæœ‰ä¸åŒçš„å‹ç¼©æ–¹å¼ï¼Œè§£å‹é€Ÿåº¦å’ŒåŒ…ä½“å¤§å°ä¹Ÿä¸åŒ(LZMA å’Œ LZ4)ã€‚
- é€‚åˆåšçƒ­æ›´ï¼Œä»¥å‡å°‘åŒ…ä½“çš„åˆå§‹å¤§å°ã€‚
- å·²åŠ è½½çš„èµ„æºä¸å…è®¸é‡å¤åŠ è½½ï¼Œä¼šæŠ¥é”™ã€‚è€Œä½¿ç”¨AssetDatabaseåˆ™ä¸éœ€è¦è€ƒè™‘ã€‚éœ€è¦ä½¿ç”¨å¼•ç”¨è®¡æ•°ã€‚

è¿™é‡Œè¿˜æœ‰ä¸€äº›å¼€æºçš„èµ„æºç®¡ç†ç³»ç»Ÿï¼Œå¦‚YooAssetã€‚

## åŒæ­¥åŠ è½½ä¸å¼‚æ­¥åŠ è½½

### åŒæ­¥åŠ è½½

åŒæ­¥åŠ è½½åœ¨åŠ è½½èµ„æºæ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹ã€‚ç­‰åŠ è½½é€»è¾‘å®Œæˆåæ‰ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ï¼ˆå›¾çµæœºï¼‰

### å¼‚æ­¥åŠ è½½

åŒæ­¥åŠ è½½åœ¨åŠ è½½è¾ƒå¤§èµ„æºæ—¶é˜»å¡æ˜æ˜¾ï¼Œé€ æˆå¡é¡¿ã€‚å› ä¸ºUnityä¸­æ‰€æœ‰çš„æ¸²æŸ“éƒ½æ˜¯æ”¾åœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹é˜»å¡éå¸¸è‡´å‘½ä¸èƒ½è¿›è¡Œä»»ä½•ç©å®¶æ“ä½œã€‚

æ‰€ä»¥éœ€è¦ä½¿ç”¨å¦å¤–ä¸€ç§åŠ è½½æ–¹å¼å¯¹è¾ƒå¤§èµ„æºè¿›è¡ŒåŠ è½½ã€‚å¼‚æ­¥åŠ è½½ä½¿ç”¨åç¨‹/çº¿ç¨‹è¿›è¡ŒåŠ è½½é€»è¾‘ï¼Œç­‰èµ„æºåŠ è½½å®Œæ¯•åè§¦å‘èµ„æºåŠ è½½åçš„callbackã€‚

åœ¨ä¸€äº›èµ„æºçš„åŠ è½½ä¼šå½±å“åˆ°æ¸¸æˆçš„å±•ç¤ºæ—¶ï¼Œå¯ä»¥åœ¨éœ€è¦ä¹‹å‰å¯¹èµ„æºè¿›è¡Œé¢„å…ˆåŠ è½½ï¼Œä¿è¯æµç¨‹èƒ½å¤Ÿé¡ºåˆ©è¿›è¡Œã€‚

#### å¼‚æ­¥åŠ è½½çš„ä¸‰ç§çŠ¶æ€

å¼‚æ­¥åŠ è½½çš„é€»è¾‘ç”±äºæ‰§è¡Œå®Œæˆçš„æ—¶é—´ä¸ç¡®å®šï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–é€»è¾‘çš„å†²çªã€‚æ‰€ä»¥æˆ‘ä»¬ç»™å¼‚æ­¥åŠ è½½æŒ‰ç…§é€»è¾‘åˆ’åˆ†çŠ¶æ€ï¼Œå¥½è®©å…¶ä»–é€»è¾‘èƒ½å¤ŸåšåŒºåˆ†ï¼Œä¸åŒçŠ¶æ€ä¸‹å¤„ç†ç›¸åº”çš„æ“ä½œã€‚

- æœªåŠ è½½

  å¼‚æ­¥åŠ è½½è¿˜æ²¡å¼€å§‹æ—¶å¯èƒ½éœ€è¦å‡†å¤‡çš„äº‹æƒ…ï¼Œæ¯”å¦‚èµ„æºåŒ…ä¸åœ¨æœ¬åœ°éœ€è¦ä¸‹è½½ã€è§£å¯†ã€è§£å‹ç­‰ç­‰ã€‚

- åŠ è½½ä¸­

  èµ„æºå¼€å§‹åŠ è½½åï¼Œå…¶ä»–ä¸šåŠ¡é€»è¾‘ä¹ŸåŠ è½½äº†ç›¸åŒèµ„æºæ—¶ï¼Œå¯ä»¥åˆ¤æ–­è¿™ä¸ªèµ„æºçš„çŠ¶æ€ã€‚æ­£åœ¨åŠ è½½åˆ™ä¸å†è¿›è¡ŒåŠ è½½å‰çš„å‡†å¤‡æ“ä½œï¼Œå¹¶æŠŠåŠ è½½åçš„callbackæ³¨å†Œè¿›å»ã€‚

- å·²åŠ è½½

  ä¸»è¦ä¸ºåŠ è½½åè§¦å‘ç›¸åº”callbackã€‚

```c#
  public enum LoaderState
    {
        NONE,           // é»˜è®¤
        LOADING,        // åŠ è½½ä¸­
        FINISHED,       // å®Œæˆ
    }
```

#### å­˜åœ¨é—®é¢˜

ç©å®¶åœ¨è¿›å…¥ä¸€ä¸ªåœºæ™¯åï¼Œå‡è®¾èµ„æºé¢„åŠ è½½éœ€è¦10sï¼Œç©å®¶å´åœ¨æœªåŠ è½½å®Œèµ„æºçš„è¿‡ç¨‹ä¸­é€€å‡ºåœºæ™¯ã€‚è¿™æ—¶å€™å°±ä¼šå¼•å‘èµ„æºçŠ¶æ€çš„é—®é¢˜ã€‚

## èµ„æºç¼“å­˜æ± 

èµ„æºç¼“å­˜æ± ä¸ºç»Ÿä¸€å­˜å‚¨å’Œè°ƒç”¨èµ„æºçš„åœ°æ–¹ã€‚åœ¨åŠ è½½èµ„æºåç»Ÿä¸€å­˜å…¥æ± å­ä¸­ï¼Œå¸è½½æ—¶åˆ™å°†å…¶ä»æ± å­ä¸­åˆ é™¤ã€‚

åŠ è½½æ—¶å…ˆåˆ¤æ–­æ± å­ä¸­æ˜¯å¦å­˜åœ¨æ­¤èµ„æºåŒ…ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡äº†ç›´æ¥åˆ™ç›´æ¥ä½¿ç”¨ï¼ŒæœªåŠ è½½å†è¿›è¡ŒåŠ è½½é€»è¾‘ã€‚

ä»¥ä¸‹å†…å®¹ä¸»è¦ä»¥AssetBundleä¸¾ä¾‹

```cc
public class AssetBundlePool{
	private Dictionary<string,AssetBundleInfo> m_LoadAssetBundle = new Dictionary<string,AssetBundleInfo>();
}
```

## å¼•ç”¨è®¡æ•°

### åŸºç¡€æ¦‚å¿µ

å¼•ç”¨æŠ€æœ¯çš„åº”ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œå¾ˆå¤šå¼•æ“ã€æ¡†æ¶ã€æ’ä»¶çš„åº•å±‚éƒ½ç¦»ä¸å¼€å¼•ç”¨è®¡æ•°ã€‚

ç®€å•æ€æƒ³ï¼šè¢«å¼•ç”¨+1ï¼Œä¸è¢«å¼•ç”¨æ—¶-1ï¼Œå½“ä¸º0æ—¶è§¦å‘æ¸…ç©ºé€»è¾‘ã€‚

```c#
public interface IRefCounter
{
    int RefCount { get; }
    void Retain();
    void Release();
}
public class SimpleRC : IRefCounter
{
    public int RefCount { get; private set; }
    public void Retain()
    {
        RefCount++;
    }
    public void Release()
    {
        RefCount--;
        if (RefCount == 0){ OnZeroRef(); }
    }
    protected virtual void OnZeroRef(){}
}

```

### ä¸èµ„æºç®¡ç†ç»“åˆçš„å¼•ç”¨è®¡æ•°

èµ„æºè¢«ä½¿ç”¨æ—¶å¼•ç”¨æ¬¡æ•°+1ï¼Œèµ„æºè§£é™¤ä½¿ç”¨æ—¶æ¬¡æ•°-1ï¼Œå½“å¼•ç”¨æ¬¡æ•°ä¸º0æ—¶åˆ™è¿›è¡Œå¸è½½é€»è¾‘ã€‚

```c#
public class AssetBundleInfo
{
    private AssetBundle m_AssetBundle;   //ABåŒ…å¼•ç”¨
    public AssetBundle AssetBundle { get { return m_AssetBundle; } }
    public int m_ReferencedCount;           //å¼•ç”¨è®¡æ•°
    public AssetBundleInfo(AssetBundle assetBundle)
    {
        m_AssetBundle = assetBundle;
        m_ReferencedCount = 1;
    }
}
```

### ä¸èµ„æºç¼“å†²æ± ç»“åˆçš„åŠ è½½

```c#
public class AssetBundlePool{
	private Dictionary<string,AssetBundleInfo> m_LoadAssetBundle = new Dictionary<string,AssetBundleInfo>();
	  public AssetBundle LoadAssetsFromAB(string abName)
    {
        AssetBundleInfo assetBundleInfo = null;
        if (m_LoadAssetBundle.TryGetValue(abName, out assetBundleInfo))
        {   //æ£€æŸ¥æ˜¯å¦åŠ è½½è¿‡
            assetBundleInfo.m_ReferencedCount++;//è¿™é‡Œå¯ä»¥ä½¿ç”¨å°è£…å¥½çš„å¼•ç”¨è®¡æ•°ï¼Œä¸ºäº†æ–¹ä¾¿å±•ç¤ºç›´æ¥ä½¿ç”¨
        }
        else
        {
            string loadPath = PathUnit.DataPath + PathUnit.ABRootPath + abName;
            var ab = AssetBundle.LoadFromFile(loadPath);
            if (ab is null)
            {
                Debug.Log("ABåŒ…åŠ è½½å¤±è´¥ï¼"+ loadPath);
            }
            else
            {
                assetBundleInfo = new AssetBundleInfo(ab);
                m_LoadAssetBundle.Add(abName, assetBundleInfo);
                //assetBundleInfo.m_ReferencedCount++;è¿™é‡Œä¸éœ€è¦åŠ äº†å› ä¸ºé»˜è®¤å€¼ä¸º1
            }
        }
        return assetBundleInfo.AssetBundle;
    }
}
```

å¼‚æ­¥åŠ è½½ä¹Ÿæ˜¯ç›¸åŒçš„æ“ä½œï¼Œä½†æœ‰ç‚¹ä¸åŒã€‚éœ€è¦ä¸€ä¸ªé¢å¤–çš„é˜Ÿåˆ—è®°å½•åŠ è½½ä¸­çš„æ–‡ä»¶ã€‚å½“åŠ è½½ä¸­çš„æ–‡ä»¶åˆæ”¶åˆ°äº†åŠ è½½è¯·æ±‚æ—¶ï¼Œåˆ™éœ€è¦åœ¨åˆ—è¡¨ä¸­æŸ¥æ‰¾æ˜¯å¦æ­£åœ¨åŠ è½½ã€‚

```c#
public class AssetBundleCachePool
{
    public MonoBehaviour monoBehaviour;
    private Dictionary<string, AssetBundleInfo> m_LoadAssetBundle = new Dictionary<string, AssetBundleInfo>();
    private Dictionary<string, Action<AssetBundle>> m_LoadingAssetBundle = new Dictionary<string, Action<AssetBundle>>();
     public void LoadAssetsFormAbAsync(string abName, Action<AssetBundle> loadingABAction)
    {
        monoBehaviour.StartCoroutine(OnLoadAssetsFormAbAsync(abName, loadingABAction));
    }
    IEnumerator OnLoadAssetsFormAbAsync(string abName, Action<AssetBundle> loadingABAction)
    {
        AssetBundleInfo assetBundleInfo = null;
        if (m_LoadAssetBundle.TryGetValue(abName,out assetBundleInfo))
        {
            Debug.Log("å·²åŠ è½½è¿‡");
            AssetBundle assetBundle = assetBundleInfo.AssetBundle;
            //å¼•ç”¨è®¡æ•°+1
            assetBundleInfo.m_ReferencedCount++;
            //è§¦å‘å›è°ƒ
            if (loadingABAction != null)
            {
                loadingABAction.Invoke(assetBundle);
            }
            yield break;
        }
        else
        {
            if (m_LoadingAssetBundle.TryGetValue(abName,out Action<AssetBundle> temploadingABAction))
            {
                if (loadingABAction != null) { temploadingABAction += loadingABAction; }
                Debug.Log("æ­£åœ¨è¢«åŠ è½½");
                yield break;
            }
            else
            {
                //è¿™æ­¥éœ€è¦æ‰§è¡Œï¼Œé¿å…ä¸å…¶ä»–é€»è¾‘å†²çª
                m_LoadingAssetBundle.Add(abName, loadingABAction);
                string loadPath = PathUnit.DataPath + PathUnit.ABRootPath + abName;
                AssetBundleCreateRequest assetBundleCreateRequest = AssetBundle.LoadFromFileAsync(loadPath);
                AssetBundle resAB = assetBundleCreateRequest.assetBundle;
                if (resAB is null)
                {
                    Debug.LogError("ABåŒ…ä¸èƒ½å­˜åœ¨");
                }
                else
                {
                    assetBundleInfo = new AssetBundleInfo(resAB);
                    m_LoadAssetBundle.Add(abName, assetBundleInfo);
                }
                //åŠ è½½å®Œæˆç§»é™¤åŠ è½½ä¸­åˆ—è¡¨
                //é¿å…å•¥å¼‚å¸¸çŠ¶å†µï¼Œä¿é™©ç‚¹ï¼å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨
                if (m_LoadingAssetBundle.ContainsKey(abName))
                {
                    Action<AssetBundle> action = m_LoadingAssetBundle[abName];
                    m_LoadingAssetBundle.Remove(abName);
                    var callBackList =  action.GetInvocationList();
                    foreach (Action<AssetBundle> callBack in callBackList)
                    {
                        callBack.Invoke(resAB);
                    }
                }
            }
        }
    }
}
```

### ä¸èµ„æºç¼“å†²æ± ç»“åˆçš„å¸è½½

ä¸ºäº†ä¿æŒ`å¹³è¡¡`æœ‰äº†åŠ è½½å°±ä¸€å®šä¼šæœ‰å¸è½½ã€‚ä½†æ˜¯åœ¨æ¸¸æˆä¸­(ç‰¹åˆ«æ˜¯æ‰‹æ¸¸)å¸è½½æ“ä½œéœ€è¦åŠ ä¸Šä¸€äº›é™åˆ¶ï¼Œå› ä¸ºåœ¨çŸ­æ—¶é—´å†…è¿›è¡Œäº†å¤§é‡èµ„æºçš„å¸è½½å¢åŠ äº†å¤§é‡çš„IOæ“ä½œä¹Ÿä¼šé€ æˆå¡é¡¿ï¼ˆçº¿ç¨‹é˜»å¡ï¼‰çš„ã€‚ğŸ™‚

æ‰€ä»¥æˆ‘ä»¬çš„å¸è½½æ“ä½œéœ€è¦ä¸æ•°é‡å’Œæ—¶é—´æ‰¯ä¸Šå…³ç³»ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…åªå¸è½½ä¸€å®šæ•°é‡çš„èµ„æºã€‚

åœ¨å¼•ç”¨è®¡æ•°ä¸­ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º0åˆ™æ ‡è®°ä¸ºå¯ä»¥å¼€å§‹å¸è½½äº†ã€‚

```c#
public class AssetBundleInfo{
     public int ReferencedCount { 
        get { return m_ReferencedCount; } 
        set {
            m_ReferencedCount = value;
            if (m_ReferencedCount<= 0)
                IsUnLoadFlag = true;
            else
                IsUnLoadFlag = false;
        }
    }
    public bool IsUnLoadFlag { get; private set; }
    private int m_ReferencedCount;           //å¼•ç”¨è®¡æ•°
}
```

#### ä¸æ—¶é—´æŒ‚é’©

ä¸æ—¶é—´æŒ‚é’©å°±éœ€è¦æœ‰ä¸ªåœ°æ–¹èƒ½å¤Ÿä¸€ç›´ç»Ÿè®¡å’Œè®¡ç®—æˆ‘ä»¬çš„æ—¶é—´å¹¶è¿›è¡Œå›æ”¶

```c#
public class ResourceManager{
    
    void Update(){
        
    }
}
```

## ä¾èµ–

æœ¬æ–‡ä¹‹å‰çš„ä»£ç éƒ½æ˜¯æ²¡æœ‰è€ƒè™‘ä¾èµ–çš„ï¼Œæ‰€ä»¥å¦‚æœçœŸçš„è·‘èµ·æ¥ä¼šå‘ç°è®¡æ•°ä¼šæœ‰åå·®ã€‚

ä¸€ä¸ªèµ„æºèº«ä¸Šç”¨åˆ°äº†åˆ«çš„ABåŒ…ä¸­çš„èµ„æºï¼Œè¿™æ—¶å€™å¦‚æœåªåŠ è½½è‡ªèº«çš„ABåŒ…ï¼Œå°±ä¼šå‡ºç°èµ„æºä¸¢å¤±çš„æƒ…å†µã€‚è¿™æ—¶å€™å°±éœ€è¦æŠŠå½“å‰èµ„æºéœ€è¦ç”¨åˆ°çš„ä¾èµ–åŒ…ä¸€èµ·åŠ è½½å‡ºæ¥ã€‚

ä½†æ˜¯æˆ‘ä»¬åˆè¦æ€ä¹ˆçŸ¥é“è¿™ä¸ªèµ„æºä¾èµ–äºå“ªäº›åŒ…ï¼Ÿ

è¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°Unityæä¾›çš„ABåŒ…ä¾èµ–æ–‡ä»¶æ¥åˆ¤æ–­ï¼Œåç¼€`.manifestÂ·`ã€‚

## AssetBundleç¯‡

Todo:sassy_woman:è¿™éƒ¨åˆ†ä»¥å‰çš„ç¬”è®°æ‰¾ä¸åˆ°äº†ï¼Œå…ˆæ¬ ç€ã€‚

## çƒ­æ›´ç¯‡

Todo:sassy_woman:è¿™éƒ¨åˆ†å†…å®¹å†™åœ¨åˆ«çš„åœ°æ–¹ï¼Œæ¯”è¾ƒä¹±åç»­æ•´ç†ã€‚