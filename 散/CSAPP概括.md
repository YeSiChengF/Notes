# CSAPP概括

## 计算机漫游

### 程序编译过程

#### 预处理

预处理器根据#开头的头文件，读取头文件内容插入源程序中，得到另外一个c程序。

预处理后的文件通常以  .i结尾，文本文件

#### 编译

词法分析、语法分析、语义分析

编译后的文件以 .s结尾，文本文件

#### 汇编

根据编译后的文件翻译成机器指令，并将这些机器指令按照固定规则进行打包。

汇编后的文件以 .o结尾 ，可重定位目标文件，还不能执行,在链接阶段进行链接

#### 链接

链接器(Id)负责把引用的已编译程序.o结尾和当前程序.o结尾进行合并。

### 了解编译过程的目的

优化程序性能

理解链接时出现的错误

避免安全漏洞

### 计算机硬件组成

#### CPU

###### PC

PC是CPU中，大小为1个字的存储区域，为某一条指令的地址。从系统上电的瞬间，直到系统断点。处理器便不断执行PC指向的指令，然后更新PC，使其指向下一条要执行的指令。

当前指令和下一条要执行的指令不一定是相邻的。

1个字在32位机器中为4个字节，在64位机器中为8个字节

###### 寄存器文件

由一些单字长的寄存器构成，每个寄存器都有唯一的名字。

临时存放数据的空间

处理器从内存中读取A的值暂存于寄存器X中，读取B的值存储于寄存器Y中。

![1639932424667](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1639932424667.png)

###### ALU算数逻辑单元

运算：将寄存器中的进行赋值，再进行算术运算，得到的结果会保存到寄存器X或寄存器Y中，寄存器中原来的数值会被新的覆盖。

#### 主存(内存)

存放指令和数据，物理上内容由随机动态存储器芯片组成。

逻辑上为从0开始的大数组，每个字节都有相应地址。

内存与CPU之间通过总线进行数据传递。

总线通常为传输固定长度的字节块，也就是字(word)

##### 输入过程

![1639933274750](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1639933274750.png)

##### 输出过程

读取数据

![1639933344828](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1639933344828.png)

复制过程使用DMA技术，数据可以不经过处理器， 从磁盘直接到达内存。

输出

![1639933440219](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1639933440219.png)

##### 高速缓存cache

寄存器和内存读取速度差异较大，通过高速缓存进行缓冲。

一般有3级缓存。

L0为寄存器文件

L1 cache，访问速度与访问寄存器文件几乎一样快。容量为数万字节(10~100kb)

L2 cache，L1速度是L2的5倍。容量为数十万到数百万字节。(0.1~10MB)

L3 cache，比L2慢。(10~100MB)

#### 存储器结构

![1639933907633](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1639933907633.png)

主要思想为，上一层存储设备是下一层存储设备的高速缓存，**可以利用存储器的存储结构来提升程序性能。**

### 操作系统

#### 文件

所有应用程序对硬件的操作都必须通过操作系统来完成      

目的：

- 防止硬件被失控的应用程序滥用
- 操作系统提供统一的机制来控制这些复杂的底层硬件

抽象：

- 文件是对IO设备的抽象
- 虚拟内存是对内存和磁盘IO的抽象
- 进程是对处理器、内存以及IO设备的抽象
- 虚拟机是对整个计算机系统的抽象

上下文(context)：操作系统会跟踪进程运行中所需要的所有状态信息，这种状态称为上下文。

每个线程都运行在线程的上下文中，共享代码和数据。

#### 虚拟内存

虚拟内存为每个进程提供了一个假象，每个进程都独自占用整个内存空间。每个进程看到的内存都是一样的，称之为 虚拟地址空间。

#### 系统加速比

阿姆达尔定律：当我们对系统的某一部分进行加速时，被加速部分的重要性和加速程度是影响整体系统性能的关键因素。

如何获得更高的计算能力？

1. 线程级并发

   一个CPU有多个核心，每个核心单独执行一个线程

   超线程：一个核心可以执行多个线程

2. 指令级并行

   同时执行多条指令的属性，每个指令从开始到结束大概需要20个时间周期或者更多。

   近几年处理器可以保持每个周期2~4条指令的执行效率。

3. 单指令，多数据并行

   一条指令产生多个并行的操作

   SIMD的指令多是为了提高处理视频，已经声音这类数据的执行速度。

### 信息

程序将内存视为一个非常大的数组，数组的元素是由一个个的字节组成，每个字节都由唯一的数字来表示，称之为地址(address)。

所有地址的集合称之为虚拟地址空间。

地址用16进制数表示，以0x开头，x可以是小写也可以是大写。地址内的字母可以是大写也可以是小写，大小写混合也是正确的。`0xFA1D37B``0xfa1d37b``0xfA1d37B`

#### 进制转换

十六进制只需记A(10)C(12)F(15)相对应的十进制值，BD通过AC+1得到，E通过F-1得到。

十六进制转换成二进制，只需要将每个十六进制数展开单独转换成二进制。

![1640536895323](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1640536895323.png)

二进制2的n次方转换成十进制就是，1后面有n个0。转换为十六进制就是n=i+4j，也可以理解为n除以4，j是商，i就是余数。

![1640537169668](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1640537169668.png)

十进制转换为十六进制，一直除以16直到不能除为止。

![1640537236184](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1640537236184.png)

#### 字长(Words)

字长决定了虚拟地址空间的最大可以到多少

一个字长为w的机器，虚拟地址的范围是`0~2的w次方-1`

32位机器虚拟地址空间最大为4GB，64位机器虚拟地址空间最大为16EB

##### 数据类型在不同字长的机器上的占用大小

![1640537556718](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1640537556718.png)

##### 例子：

一个int类型的变量x(0x01234567)，假设地址位于0x100处。int类型占4个字节，因此变量x被存储在地址为0x100、0x101、0x102、0x103的内存处。

**大端法**

最高有效字节存储在最前面，低地址处。

**小端法**

最低有效字节存储在最前面，高地址处。

![1640537839022](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1640537839022.png)

#### 字符串

在C语言中，字符串是以null(结尾字符)结尾

如字符串`const char *s="abcd"` s.Length=6

null结尾字符的十六进制表示为`0x00`

使用ASCII码表示字符，在任何操作系统上都会得到相同的结果

文本数据比二进制数据具有更强的平台独立性

#### 逻辑代数

位运算 ~非  |或  &与  ^异或(相等为0，不等为1)

逻辑运算 ||或  &&与  !非

##### 移位运算 

左移(抛弃左边，右边补0)

###### 右移

**逻辑右移**

和左移相同

无符号数的右移一定是逻辑右移

**算数右移**

最高位为0时，最高位补0

最高位为1时，最高位补1

有符号数的右移一定是算数右移