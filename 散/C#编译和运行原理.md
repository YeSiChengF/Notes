# C#编译和运行原理

https://www.cnblogs.com/Tpf386/p/6479675.html

## 编译与内存的关系

**全局变量、静态变量(包含一些复杂类型的常量)**，所需的空间大小可以明确计算并且不会发生改变，所以可以**直接存储在可执行文件的特定的节**中(包含初始化的值)。

程序运行时，直接将这个节加载到特定的段中，不必在程序运行期间用额外代买来产生这些变量。

编译分配空间，准确来说是编译期间编译器为你规划好了这些变量的内存使用方案，这个方案写到可执行文件内，直到程序运行才拿出来执行。

## 编译

编译是一个扫描过程，进行词法语法检查，代码优化。

编译时赋初值，只是形成文本检查无错误，并没有分配内存。当运行时，系统才将程序导入内存中。

一个进程(运行的程序)主要包括五个分区：

栈区、堆区、全局数据区/静态区、代码区、常量区

- 栈区用来存放局部数据或者是函数的参数，函数的返回值之类的变量（其中还有返回到调用函数下一条指令的地址）
- 堆区用来存放程序中动态申请内存的变量
- 全局变量/静态区用来存放程序中的全局变量或者是静态变量，因为它们的大小是确定的，在编译期间就已经进行静态空间的分配，而且不会改变，这样会提高程序对这些数据的访问速度
- 代码区（code）用来存放编译后的二进制代码
- 常量区用来存放我们声明的常量（const类型）

## 小结

编译时不分配内存，程序只有执行时才进行内存分配。此时只是根据声明时的类型进行占位，声明是提供给编译器看的。

运行时分配内存，运行时程序必须调用到内存(所有程序和全局变量，一直占用到退出程序)。程序进入实际内存前要首先分配物理内存。

编译过程， 当执行这个EXE文件以后，此程序就被加载到内存中，成为进程。 

## 托管环境

托管语言C#和Java在IDE中编写代码会自动进行检测，然后编译成目标文件和链接到动态/静态库或可执行文件进行再次检查（语法分析），最后一次检查是运行时检查。托管环境的共同特点是：编译器不直接编译成机器码，而是**中间代码**(MSIL)。

之后再运行JIT编译器将MSIL(中间语言)翻译成机器码，代码在真正使用的时候才被解析。

 这允许在[CLR](http://en.wikipedia.org/wiki/Common_Language_Runtime)（公共语言运行时）预编译和优化我们的代码，实现程序性能的提高，但增加了程序的启动时间，我们也可以使用Ngen（Native Image Generator）预编译我们的程序，从而缩短程序的启动时间，但没有运行时优化的优点。 

## JIT编译的优点和缺点

JIT编译允许CLR只执行需要的代码，性能更有优势。

缺点启动的过程比较慢，不适合加载时间长的包。

在非托管环境中，编译的过程分为编译和连接两个阶段。

编译阶段将源程序（*.c，*.cpp或*.h)转换成为目标代码(*.o或*.obj文件），至于具体过程就是上面说的C/C++编译过程的前三个阶段；链接阶段是把前面转成成的目标代码（obj文件）与我们程序里面调用的库函数对应的代码链接起来形成对应的可执行文件（exe文件）。